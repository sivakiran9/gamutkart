node {
    def app

    stage('Clone repository') {
        /* Cloning the Repository to our Workspace */

        checkout scm
     }

    stage('Build image') {
        /* This builds the actual image */

        app = docker.build("kiran787/tomcat")
     } 

     stage('Test image') {
   
          app.inside {
              echo "Tests passed"
          }
     } 

     stage('push image') {
          /*
                         You would need to first register with DockerHub before you can push images to your account 
                 */
          docker.withRegistry('https://registry.hub.docker.com', 'docker-hub') {
               app.push("${env.BUILD_NUMBER}")
               app.push("latest")
               }
                   echo "Trying to Push Docker Build to DockerHub"
     }
   
     stage('Deployment') {
                    steps {
                          sh 'sshpass -p "123" scp target/gamutkart.war satya@172.17.0.2:/home/satya/distros/apache-tomcat-8.5.39/webapps'                    }
     }
     stage('Startup') {
                    steps {
                          sh 'sshpass -p "123" ssh -o StrictHostKeyChecking=no satya@172.17.0.2 JAVA_HOME=/home/satya/distros/jdk1.8.0_201 /home/satya/distros/apache-tomcat-8.5.39/bin/startup.sh'
     }
     }
    }
  }

 


